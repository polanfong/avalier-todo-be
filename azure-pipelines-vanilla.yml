#https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/dotnet-core?view=azure-devops
#https://www.azuredevopslabs.com/labs/vstsextend/sonarqube/

name: $(date:yyyyMMdd)$(rev:.r)-$(Build.SourceBranch)

trigger:
  branches:
    include:
    - '*'
  tags:
    include:
    - '*'

resources:
- repo: self

variables:
  vmImageName: 'ubuntu-latest'
  dockerId: 'avalier.azurecr.io'
  dockerImageName: 'avalier-todo-be'

jobs:  
- job: BuildAndTest
  displayName: Build & Test
  pool:
    vmImage: $(vmImageName)
  steps:
  - template: templates/dotnet-build-and-test.yml
- job: CreateDockerImage
  displayName: Create Docker Image
  dependsOn: BuildAndTest
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest')) #, startsWith(variables['Build.SourceBranch'], 'refs/tags/')
  pool:
    vmImage: $(vmImageName)
  variables:
    label: ''
  steps:
  - script: |
      # Replace "refs/tags/"" with ""
      BuildSourceBranch=$(Build.SourceBranch)
      dockerTagName=${BuildSourceBranch/refs\/tags\//}
      echo TagName: $dockerTagName
      # Export TagName
      echo "##vso[task.setvariable variable=dockerTagName;]$dockerTagName"
  - template: templates/docker-build-and-push.yml
    parameters:
      dockerId: $(dockerId)
      dockerTagName: $(dockerTagName)
      dockerImageName: $(dockerImageName)
