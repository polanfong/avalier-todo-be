
parameters:
  dockerId: ''
  dockerTagName: ''
  dockerImageName: ''

steps:

- script: |
    if [ ! -z "$(dockerId)" ]; then
      echo Parameter not specified: dockerId
    fi
    if [ ! -z "$(dockerTagName)" ]; then
      echo Parameter not specified: dockerTagName
    fi
    if [ ! -z "$(dockerImageName)" ]; then
      echo Parameter not specified: dockerImageName
    fi
  displayName: Parameter Validation

- script: |
    docker build -t '$(dockerId)/$(dockerImageName):latest' ./src
  displayName: Docker - Build & Tag

- script: |
    docker tag '$(dockerId)/$(dockerImageName):latest' '$(dockerId)/$(dockerImageName):$(dockerTagName)'
  displayName: Docker - Tag

- script: |
    docker image list | grep $(dockerId)
  displayName: Docker - List

#- script: |
  #    sudo apt-get -y install rpm
  #    wget https://github.com/aquasecurity/trivy/releases/download/v0.1.6/trivy_0.1.6_Linux-64bit.deb
  #    sudo dpkg -i trivy_0.1.6_Linux-64bit.deb
  #  displayName: Docker - Trivy Installation (Container Security Analysis by Aquasec)

  #- script: |
  #    trivy --only-update alpine '$(dockerId)/$(dockerImageName):$(Build.BuildNumber)'
  #  displayName: Docker - Trivy Execution (Container Security Analysis by Aquasec)

- task: Docker@2
  displayName: Docker - Login
  inputs:
    command: login
    containerRegistry: dockerRegistryServiceConnection

- task: Docker@2
  displayName: Docker - Push
  inputs:
    command: push
    containerRegistry: dockerRegistryServiceConnection
    repository: '$(dockerImageName)'
    tags: |
      latest
      $(dockerTagName)
