
parameters:
  dockerId: 'avalier.azurecr.io'
  dockerTagName: ''
  dockerImageName: 'avalier-todo-be'

steps:
- script: |
    docker build -t '$(dockerId)/$(dockerImageName):latest' ./src
  displayName: Docker - Build

- script: |
    docker tag '$(dockerId)/$(dockerImageName):latest' '$(dockerId)/$(dockerImageName):$(Build.BuildNumber)'
    if [ ! -z "$(tagName)" ]; then
      docker tag '$(dockerId)/$(dockerImageName):latest' '$(dockerId)/$(dockerImageName):$(tagName)'
    fi
  displayName: Docker - Tag

- script: |
    docker image list | grep $(dockerId)
  displayName: Docker - List

#- script: |
  #    sudo apt-get -y install rpm
  #    wget https://github.com/aquasecurity/trivy/releases/download/v0.1.6/trivy_0.1.6_Linux-64bit.deb
  #    sudo dpkg -i trivy_0.1.6_Linux-64bit.deb
  #  displayName: Docker - Trivy Installation (Container Security Analysis by Aquasec)

  #- script: |
  #    trivy --only-update alpine '$(dockerId)/$(dockerImageName):$(Build.BuildNumber)'
  #  displayName: Docker - Trivy Execution (Container Security Analysis by Aquasec)

- task: Docker@2
  displayName: Docker - Login
  inputs:
    command: login
    containerRegistry: dockerRegistryServiceConnection

- task: Docker@2
  displayName: Docker - Push
  inputs:
    command: push
    containerRegistry: dockerRegistryServiceConnection
    repository: '$(dockerImageName)'
    tags: |
      latest
      $(Build.BuildNumber)
      $(dockerTagName)
